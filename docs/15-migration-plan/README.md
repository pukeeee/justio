# Розділ 15: План Міграції (з MVP на Масштабований VPS)

Коли проєкт переросте можливості безкоштовних тарифів або потребуватиме більшого контролю над інфраструктурою, буде здійснено міграцію з керованих сервісів (Vercel, Supabase) на власні або орендовані віртуальні сервери (VPS). Цей план забезпечує плавний перехід з мінімальними змінами в коді.

### Крок 1: Підготовка Середовища на VPS

*   **Вибір хостингу:** Оренда віртуального сервера у хмарного провайдера (наприклад, DigitalOcean, Hetzner, AWS) з достатніми ресурсами (напр., 4 vCPU, 8GB RAM).
*   **Контейнеризація (Docker):** Усі компоненти архітектури (додаток Next.js, база даних PostgreSQL, Redis, RabbitMQ) будуть запаковані в Docker-контейнери. `Docker Compose` буде використовуватись для оркестрації цих сервісів на одному сервері.
*   **Налаштування PostgreSQL:** Розгортання власного екземпляру PostgreSQL. Схема даних та всі RLS-політики будуть перенесені з Supabase за допомогою `pg_dump`.
*   **Налаштування Redis та RabbitMQ:** Розгортання відповідних контейнерів. На початковому етапі вони можуть бути не інтегровані в код, але інфраструктура буде готова.
*   **Тестування середовища:** Запуск всього стеку на новому сервері з копією даних для перевірки працездатності всіх компонентів, особливо автентифікації.

### Крок 2: Міграція Системи Автентифікації

Це найскладніший етап, оскільки потрібно замінити керований сервіс Supabase Auth.

*   **Варіант А (Пріоритетний):** Самостійне розміщення **GoTrue**. GoTrue — це відкритий сервіс автентифікації від Supabase. Розгорнувши його на власному сервері та підключивши до нашої БД, ми зможемо зберегти існуючі облікові дані користувачів (включаючи хеші паролів), що зробить міграцію прозорою для них.
*   **Варіант Б (Резервний):** Перехід на **NextAuth** або власну реалізацію. Це може вимагати скидання паролів для всіх користувачів (через email), оскільки перенести хеші паролів з Supabase може бути складно через відмінності у використанні "солей" та алгоритмів.
*   **Перевірка JWT та RLS:** Незалежно від обраного варіанту, потрібно переконатися, що нова система автентифікації генерує JWT-токени з тими ж полями (`claims`), що й Supabase, щоб політики RLS продовжували працювати коректно.

### Крок 3: Розгортання Додатку та Переключення DNS

*   **Комунікація з користувачами:** Заздалегідь повідомити користувачів про заплановані технічні роботи та можливий короткочасний простій.
*   **"Заморозка" даних:** Оголошення короткого вікна для технічних робіт (в ідеалі — вночі або на вихідних). На цей час у старому додатку можна тимчасово вимкнути функції запису.
*   **Цілісність даних:** Створення останньої резервної копії даних з Supabase та її відновлення на новому сервері. Після переключення зберегти стару базу даних у режимі "тільки для читання" на деякий час для можливості перевірки даних.
*   **Переключення DNS:** Зміна DNS-записів домену, щоб вони вказували на IP-адресу нового сервера. Для забезпечення HTTPS буде налаштовано Nginx або Caddy з автоматичним отриманням сертифікатів від Let's Encrypt.
*   **Моніторинг:** Ретельний моніторинг логів одразу після переключення для виявлення будь-яких помилок.

**План відкату (Rollback Plan):** Завжди потрібно мати можливість швидко повернутися до старої інфраструктури. Для цього достатньо переключити DNS-записи назад на Vercel. Старе середовище на Supabase/Vercel не видаляється одразу, а залишається в режимі "stand-by".

### Крок 4: Пост-міграційні Покращення

Після успішної міграції ми можемо поступово впроваджувати переваги нової інфраструктури.

*   **Інтеграція Redis:** Використання Redis для кешування важких запитів до бази даних, що зменшить навантаження на неї.
*   **Впровадження черг (RabbitMQ):** Рефакторинг довготривалих операцій (відправка email, генерація звітів), щоб вони виконувалися не в основному потоці запиту, а асинхронно у фонових процесах (workers). Це значно покращить відгукливість інтерфейсу.
*   **Масштабування:** За потреби можна буде легко масштабувати окремі частини системи: запустити кілька екземплярів Next.js-додатку за балансувальником навантаження або налаштувати реплікацію бази даних.
*   **Розширений моніторинг:** Впровадження повноцінного моніторингу (Prometheus/Grafana) та централізованого збору логів (ELK Stack).

Цей план дозволяє еволюційно розвивати інфраструктуру, уникаючи кардинальних змін у бізнес-логіці додатку.